<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Price of Perfection: What Makes a $175-Per-Ounce Coffee Worth It</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #121212;
            --text-secondary: #666;
            --border-color: #e2e2e2;
            --grid-color: #f0f0f0;
            --highlight-bg: #f8f8f8;
            --accent-color: #ff6b35;
            --data-point-color: #1f77b4;
            --tooltip-bg: rgba(18, 18, 18, 0.95);
            --tooltip-text: white;
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e8e8e8;
            --text-secondary: #b0b0b0;
            --border-color: #333;
            --grid-color: #2a2a2a;
            --highlight-bg: #2a2a2a;
            --accent-color: #ff7b47;
            --data-point-color: #4a9eff;
            --tooltip-bg: rgba(240, 240, 240, 0.95);
            --tooltip-text: #121212;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: "nyt-cheltenham", "nyt-imperial", Georgia, "Times New Roman", Times, serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .story-container {
            max-width: 1050px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .headline {
            font-family: "nyt-cheltenham", Georgia, serif;
            font-size: clamp(32px, 5vw, 48px);
            font-weight: 700;
            line-height: 1.1;
            margin: 40px 0 20px 0;
            color: var(--text-color);
        }
        
        .subhead {
            font-family: "nyt-imperial", Georgia, serif;
            font-size: clamp(18px, 2.5vw, 24px);
            font-weight: 400;
            color: var(--text-secondary);
            margin-bottom: 40px;
            line-height: 1.4;
        }
        
        .byline {
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dark-mode-toggle {
            background: var(--highlight-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .dark-mode-toggle:hover {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .dark-mode-toggle .sun-icon {
            display: inline;
        }
        
        .dark-mode-toggle .moon-icon {
            display: none;
        }
        
        [data-theme="dark"] .dark-mode-toggle .sun-icon {
            display: none;
        }
        
        [data-theme="dark"] .dark-mode-toggle .moon-icon {
            display: inline;
        }
        
        .story-text {
            font-family: "nyt-imperial", Georgia, serif;
            font-size: 20px;
            line-height: 1.7;
            color: var(--text-color);
            margin-bottom: 40px;
            max-width: 600px;
        }
        
        .story-text p {
            margin-bottom: 20px;
        }
        
        .story-text .dropcap {
            float: left;
            font-family: "nyt-cheltenham", Georgia, serif;
            font-size: 84px;
            line-height: 1;
            padding-right: 8px;
            padding-top: 4px;
            font-weight: 700;
        }
        
        .chart-section {
            margin: 60px 0;
            clear: both;
        }
        
        .chart-container {
            margin-bottom: 80px;
        }
        
        .chart-headline {
            font-family: "nyt-cheltenham", Georgia, serif;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .chart-subhead {
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 500px;
        }
        
        .axis {
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .axis-label {
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .grid line {
            stroke: var(--grid-color);
            stroke-width: 1;
            opacity: 0.7;
        }
        
        .grid path {
            stroke-width: 0;
        }
        
        .axis line, .axis path {
            stroke: var(--text-color);
            stroke-width: 1;
        }
        
        .tooltip {
            position: absolute;
            background: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 12px 16px;
            border-radius: 4px;
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px);
        }
        
        .trend-line {
            fill: none;
            stroke: var(--accent-color);
            stroke-width: 3;
            opacity: 0.8;
        }
        
        .data-point {
            fill: var(--data-point-color);
            opacity: 0.4;
            transition: opacity 0.2s ease;
        }
        
        .data-point:hover {
            opacity: 0.8;
        }
        
        .pullquote {
            font-family: "nyt-cheltenham", Georgia, serif;
            font-size: 28px;
            line-height: 1.3;
            color: var(--text-color);
            margin: 40px 0;
            padding: 0 40px;
            border-left: 4px solid var(--accent-color);
            font-weight: 400;
            font-style: italic;
        }
        
        .highlight-box {
            background: var(--highlight-bg);
            border-left: 4px solid var(--accent-color);
            padding: 20px;
            margin: 40px 0;
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        
        .highlight-box h3 {
            font-family: "nyt-cheltenham", Georgia, serif;
            font-size: 18px;
            margin-top: 0;
            color: var(--text-color);
        }
        
        footer {
            margin-top: 80px;
            padding: 40px 0;
            border-top: 1px solid var(--border-color);
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .methodology {
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .outlier-controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .outlier-btn {
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background: var(--highlight-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .outlier-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .outlier-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .outlier-narrative {
            background: var(--highlight-bg);
            border-left: 4px solid var(--accent-color);
            padding: 20px;
            margin-top: 20px;
            font-family: "nyt-imperial", Georgia, serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-color);
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease;
        }
        
        .outlier-narrative.show {
            opacity: 1;
            max-height: 300px;
        }
        
        .outlier-annotation {
            pointer-events: none;
            font-family: "nyt-franklin", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 12px;
            fill: var(--text-color);
            font-weight: 500;
        }
        
        .outlier-line {
            stroke: var(--accent-color);
            stroke-width: 1;
            stroke-dasharray: 2,2;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .outlier-point {
            stroke: var(--accent-color);
            stroke-width: 2;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .outlier-point.show {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .story-container {
                padding: 0 15px;
            }
            
            .pullquote {
                font-size: 22px;
                padding: 0 20px;
            }
            
            .chart-headline {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div id="tooltip" class="tooltip"></div>
    
    <div class="story-container">
        <h1 class="headline">The Price of Perfection: What Makes a $175-Per-Ounce Coffee Worth It</h1>
        
        <div class="subhead">An analysis of 3,779 coffee reviews reveals the surprising relationship between price, sensory scores, and what coffee lovers are actually paying for.</div>
        
        <div class="byline">
            By Data Visualization Team ‚Ä¢ Published Today
            <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle dark mode">
                <span class="sun-icon">‚òÄÔ∏è</span>
                <span class="moon-icon">üåô</span>
            </button>
        </div>
        
        <div class="story-text">
            <p><span class="dropcap">I</span>n a world where a cup of coffee can cost anywhere from 50 cents to $50, what exactly determines the price we're willing to pay for our daily brew? Our analysis of nearly 4,000 professional coffee reviews reveals a complex relationship between price, aroma, flavor, and overall rating that challenges conventional wisdom about luxury coffee.</p>
            
            <p>The data, sourced from CoffeeReview.com's comprehensive database, tells a story of diminishing returns, quality thresholds, and the premium consumers pay for perfection. While most coffee falls into a predictable sweet spot of quality and price, the outliers‚Äîthose $100+ per ounce rarities‚Äîoperate by entirely different rules.</p>
        </div>
        
        <div class="chart-section">
            <div class="chart-container">
                <div class="chart-headline">Price Doesn't Always Predict Quality</div>
                <div class="chart-subhead">While there's a general upward trend, some of the highest-rated coffees cost less than $5 per ounce</div>
                <svg id="price-chart"></svg>
            </div>
        </div>
        
        <div class="story-text">
            <p>The relationship between price and rating reveals the first surprise: excellence doesn't require extravagance. Some of the highest-rated coffees in our dataset‚Äîthose scoring 95+ points‚Äîcost less than $5 per ounce. Meanwhile, coffees priced above $50 per ounce show inconsistent quality, suggesting that extreme pricing often reflects rarity or marketing rather than pure taste.</p>
        </div>
        
        <div class="pullquote">
            "The sweet spot for exceptional coffee appears to be between $2-$10 per ounce, where quality and value intersect most favorably."
        </div>
        
        <div class="chart-section">
            <div class="chart-container">
                <div class="chart-headline">Aroma: The Most Reliable Predictor of Excellence</div>
                <div class="chart-subhead">Higher aroma scores show the strongest correlation with overall rating, but some coffees still defy expectations</div>
                <div class="outlier-controls">
                    <button id="show-aroma-anomalies" class="outlier-btn">Show Anomalies</button>
                    <button id="show-aroma-champions" class="outlier-btn">Show Champions</button>
                    <button id="show-aroma-all" class="outlier-btn active">Show All</button>
                </div>
                <svg id="aroma-chart"></svg>
                <div id="aroma-story" class="outlier-narrative"></div>
            </div>
        </div>
        
        <div class="story-text">
            <p>Professional coffee reviewers use a 10-point scale to evaluate aroma, and our analysis shows this metric is remarkably predictive of overall satisfaction. Coffees scoring 9 or 10 on aroma rarely disappoint, clustering tightly in the 92-97 rating range. This suggests that a coffee's smell‚Äîoften the first sensory experience‚Äîis indeed a reliable indicator of quality.</p>
        </div>
        
        <div class="highlight-box">
            <h3>The Science Behind Aroma</h3>
            <p>Coffee's aroma comes from over 800 volatile compounds that develop during roasting. These compounds not only signal proper roasting technique but also influence taste perception through retronasal olfaction‚Äîthe phenomenon where smell enhances flavor.</p>
        </div>
        
        <div class="chart-section">
            <div class="chart-container">
                <div class="chart-headline">The Flavor Paradox: When Great Taste Doesn't Guarantee Great Ratings</div>
                <div class="chart-subhead">While flavor strongly predicts rating, some outliers reveal the complex psychology of coffee evaluation</div>
                <div class="outlier-controls">
                    <button id="show-overachievers" class="outlier-btn">Show Overachievers</button>
                    <button id="show-underachievers" class="outlier-btn">Show Disappointments</button>
                    <button id="show-all" class="outlier-btn active">Show All</button>
                </div>
                <svg id="flavor-chart"></svg>
                <div id="outlier-story" class="outlier-narrative"></div>
            </div>
        </div>
        
        <div class="story-text">
            <p>As expected, flavor shows the strongest correlation with overall rating. However, the distribution reveals interesting patterns: while poor flavor (scores below 8) virtually guarantees a mediocre rating, excellent flavor scores alone don't guarantee premium pricing. This suggests that other factors‚Äîorigin rarity, processing methods, or brand reputation‚Äîdrive the highest prices.</p>
            
            <p>The data ultimately reveals that coffee excellence is more democratic than its pricing suggests. While the most expensive coffees can indeed be exceptional, the path to a truly great cup doesn't require breaking the bank. The sweet spot for exceptional coffee appears to be between $2-$10 per ounce, where passionate roasters focus on perfecting their craft rather than chasing premium positioning.</p>
        </div>
        
        <div class="methodology">
            <strong>Methodology:</strong> This analysis is based on 3,779 coffee reviews from CoffeeReview.com, filtered to remove outliers (keeping data within the 0.5-99.5 percentile range for each metric). Price represents cost per ounce calculated from listed retail prices. Rating data reflects professional cupping scores on a 100-point scale.
        </div>
        
        <footer>
            Data visualization of coffee reviews. Source: <a href="https://coffeereview.com" target="_blank" style="color: #326891;">CoffeeReview.com</a>
        </footer>
    </div>

    <script>
        let data = [];
        const tooltip = d3.select("#tooltip");
        
        const margin = {top: 20, right: 30, bottom: 60, left: 70};
        let width = Math.min(window.innerWidth - 40, 800) - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;
        
        // Enhanced LOESS implementation
        function loess(data, bandwidth = 0.25) {
            const n = data.length;
            const result = [];
            const sortedData = data.sort((a, b) => a.x - b.x);
            
            for (let i = 0; i < n; i += Math.max(1, Math.floor(n / 50))) {
                const x0 = sortedData[i].x;
                const distances = sortedData.map(d => Math.abs(d.x - x0));
                const maxDistance = d3.quantile(distances.sort(d3.ascending), bandwidth);
                
                let sumWeights = 0;
                let sumWeightedY = 0;
                
                for (let j = 0; j < n; j++) {
                    const distance = Math.abs(sortedData[j].x - x0);
                    if (distance <= maxDistance) {
                        const weight = Math.pow(1 - Math.pow(distance / maxDistance, 3), 3);
                        sumWeights += weight;
                        sumWeightedY += weight * sortedData[j].y;
                    }
                }
                
                if (sumWeights > 0) {
                    result.push({x: x0, y: sumWeightedY / sumWeights});
                }
            }
            
            return result;
        }
        
        function createChart(svgId, xField, xLabel, chartType) {
            const svg = d3.select(`#${svgId}`)
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom);
            
            svg.selectAll("*").remove();
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // Scales
            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d[xField]))
                .range([0, width]);
            
            const yScale = d3.scaleLinear()
                .domain([85, 98])
                .range([height, 0]);
            
            // Grid lines
            g.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xScale)
                    .ticks(chartType === 'price' ? 8 : 6)
                    .tickSize(-height)
                    .tickFormat(""));
            
            g.append("g")
                .attr("class", "grid")
                .call(d3.axisLeft(yScale)
                    .ticks(6)
                    .tickSize(-width)
                    .tickFormat(""));
            
            // Axes
            const xAxis = chartType === 'price' ? 
                d3.axisBottom(xScale).ticks(8).tickFormat(d => `$${d}`) :
                d3.axisBottom(xScale).ticks(6);
                
            g.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);
            
            g.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(yScale).ticks(6));
            
            // Axis labels
            g.append("text")
                .attr("class", "axis-label")
                .attr("transform", `translate(${width/2}, ${height + 45})`)
                .style("text-anchor", "middle")
                .text(xLabel);
            
            g.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left + 20)
                .attr("x", 0 - (height / 2))
                .style("text-anchor", "middle")
                .text("Overall Rating");
            
            // Enhanced trend line (draw first so points appear on top)
            const loessData = loess(data.map(d => ({x: d[xField], y: d.rating})));
            
            const line = d3.line()
                .x(d => xScale(d.x))
                .y(d => yScale(d.y))
                .curve(d3.curveCardinal);
            
            g.append("path")
                .datum(loessData)
                .attr("class", "trend-line")
                .attr("d", line);
            
            // Data points with enhanced styling
            g.selectAll(".data-point")
                .data(data)
                .enter().append("circle")
                .attr("class", "data-point")
                .attr("r", 2.5)
                .attr("cx", d => xScale(d[xField]))
                .attr("cy", d => yScale(d.rating))
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("r", 4);
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`
                        <strong>${xLabel}:</strong> ${chartType === 'price' ? '$' + d[xField].toFixed(2) : d[xField].toFixed(1)}<br>
                        <strong>Rating:</strong> ${d.rating}<br>
                        <strong>Aroma:</strong> ${d.aroma}<br>
                        <strong>Flavor:</strong> ${d.flavor}
                    `)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("r", 2.5);
                    tooltip.transition().duration(300).style("opacity", 0);
                });
            
            // Special handling for outliers
            if (chartType === 'flavor') {
                createFlavorOutliers(g, xScale, yScale);
            } else if (chartType === 'aroma') {
                createAromaOutliers(g, xScale, yScale);
            }
        }
        
        function createFlavorOutliers(g, xScale, yScale) {
            // Calculate expected rating for each point based on trend
            const loessData = loess(data.map(d => ({x: d.flavor, y: d.rating})));
            
            // Find outliers
            const outliers = data.map(d => {
                // Find closest trend point
                const closest = loessData.reduce((prev, curr) => 
                    Math.abs(curr.x - d.flavor) < Math.abs(prev.x - d.flavor) ? curr : prev
                );
                const deviation = d.rating - closest.y;
                return {
                    ...d,
                    deviation,
                    isOverachiever: deviation > 2.5,
                    isUnderachiever: deviation < -2.5
                };
            });
            
            const overachievers = outliers.filter(d => d.isOverachiever);
            const underachievers = outliers.filter(d => d.isUnderachiever);
            
            // Create outlier groups
            const outlierGroup = g.append("g").attr("class", "outlier-annotations");
            
            // Overachiever points
            outlierGroup.selectAll(".overachiever")
                .data(overachievers)
                .enter().append("circle")
                .attr("class", "outlier-point overachiever")
                .attr("r", 4)
                .attr("cx", d => xScale(d.flavor))
                .attr("cy", d => yScale(d.rating))
                .attr("fill", "none");
            
            // Underachiever points  
            outlierGroup.selectAll(".underachiever")
                .data(underachievers)
                .enter().append("circle")
                .attr("class", "outlier-point underachiever")
                .attr("r", 4)
                .attr("cx", d => xScale(d.flavor))
                .attr("cy", d => yScale(d.rating))
                .attr("fill", "none");
            
            // Annotation lines and labels for top outliers
            const topOverachiever = overachievers.sort((a, b) => b.deviation - a.deviation)[0];
            const topUnderachiever = underachievers.sort((a, b) => a.deviation - b.deviation)[0];
            
            if (topOverachiever) {
                const x = xScale(topOverachiever.flavor);
                const y = yScale(topOverachiever.rating);
                
                outlierGroup.append("line")
                    .attr("class", "outlier-line overachiever-line")
                    .attr("x1", x).attr("y1", y)
                    .attr("x2", x + 40).attr("y2", y - 30);
                
                outlierGroup.append("text")
                    .attr("class", "outlier-annotation overachiever-text")
                    .attr("x", x + 45).attr("y", y - 35)
                    .text(`Exceeds expectations by ${topOverachiever.deviation.toFixed(1)} points`);
            }
            
            if (topUnderachiever) {
                const x = xScale(topUnderachiever.flavor);
                const y = yScale(topUnderachiever.rating);
                
                outlierGroup.append("line")
                    .attr("class", "outlier-line underachiever-line")
                    .attr("x1", x).attr("y1", y)
                    .attr("x2", x - 40).attr("y2", y + 30);
                
                outlierGroup.append("text")
                    .attr("class", "outlier-annotation underachiever-text")
                    .attr("x", x - 45).attr("y", y + 35)
                    .attr("text-anchor", "end")
                    .text(`Falls short by ${Math.abs(topUnderachiever.deviation).toFixed(1)} points`);
            }
            
            // Store outlier data for interactive controls
            window.flavorOutliers = { overachievers, underachievers };
        }
        
        function createAromaOutliers(g, xScale, yScale) {
            // Calculate expected rating for each point based on trend
            const loessData = loess(data.map(d => ({x: d.aroma, y: d.rating})));
            
            // Find outliers with different thresholds for aroma (since it's more reliable)
            const outliers = data.map(d => {
                // Find closest trend point
                const closest = loessData.reduce((prev, curr) => 
                    Math.abs(curr.x - d.aroma) < Math.abs(prev.x - d.aroma) ? curr : prev
                );
                const deviation = d.rating - closest.y;
                return {
                    ...d,
                    deviation,
                    isAnomaly: Math.abs(deviation) > 2.0, // Lower threshold since aroma is more reliable
                    isChampion: d.aroma >= 9.5 && d.rating >= 95, // Elite combination
                    isLowAroma: d.aroma <= 8.0 && d.rating >= 92 // Surprising high ratings despite poor aroma
                };
            });
            
            const anomalies = outliers.filter(d => d.isAnomaly);
            const champions = outliers.filter(d => d.isChampion);
            const lowAromaStars = outliers.filter(d => d.isLowAroma);
            
            // Create outlier groups
            const outlierGroup = g.append("g").attr("class", "aroma-outlier-annotations");
            
            // Anomaly points (both over and under performers)
            outlierGroup.selectAll(".aroma-anomaly")
                .data(anomalies)
                .enter().append("circle")
                .attr("class", "outlier-point aroma-anomaly")
                .attr("r", 4)
                .attr("cx", d => xScale(d.aroma))
                .attr("cy", d => yScale(d.rating))
                .attr("fill", "none")
                .attr("stroke", d => d.deviation > 0 ? "#4CAF50" : "#f44336");
            
            // Champion points (perfect aroma + rating combo)
            outlierGroup.selectAll(".aroma-champion")
                .data(champions)
                .enter().append("circle")
                .attr("class", "outlier-point aroma-champion")
                .attr("r", 5)
                .attr("cx", d => xScale(d.aroma))
                .attr("cy", d => yScale(d.rating))
                .attr("fill", "none")
                .attr("stroke", "#FFD700")
                .attr("stroke-width", 3);
            
            // Low aroma stars
            outlierGroup.selectAll(".aroma-star")
                .data(lowAromaStars)
                .enter().append("circle")
                .attr("class", "outlier-point aroma-star")
                .attr("r", 4)
                .attr("cx", d => xScale(d.aroma))
                .attr("cy", d => yScale(d.rating))
                .attr("fill", "none")
                .attr("stroke", "#9C27B0");
            
            // Annotations for most interesting cases
            const topChampion = champions.sort((a, b) => (b.aroma + b.rating) - (a.aroma + a.rating))[0];
            const biggestAnomaly = anomalies.sort((a, b) => Math.abs(b.deviation) - Math.abs(a.deviation))[0];
            const bestLowAroma = lowAromaStars.sort((a, b) => b.rating - a.rating)[0];
            
            if (topChampion) {
                const x = xScale(topChampion.aroma);
                const y = yScale(topChampion.rating);
                
                outlierGroup.append("line")
                    .attr("class", "outlier-line champion-line")
                    .attr("x1", x).attr("y1", y)
                    .attr("x2", x - 50).attr("y2", y - 25);
                
                outlierGroup.append("text")
                    .attr("class", "outlier-annotation champion-text")
                    .attr("x", x - 55).attr("y", y - 30)
                    .attr("text-anchor", "end")
                    .text(`Perfect combo: ${topChampion.aroma}/10 aroma, ${topChampion.rating} rating`);
            }
            
            if (biggestAnomaly) {
                const x = xScale(biggestAnomaly.aroma);
                const y = yScale(biggestAnomaly.rating);
                
                outlierGroup.append("line")
                    .attr("class", "outlier-line anomaly-line")
                    .attr("x1", x).attr("y1", y)
                    .attr("x2", x + 40).attr("y2", y + (biggestAnomaly.deviation > 0 ? -30 : 30));
                
                outlierGroup.append("text")
                    .attr("class", "outlier-annotation anomaly-text")
                    .attr("x", x + 45).attr("y", y + (biggestAnomaly.deviation > 0 ? -35 : 35))
                    .text(`${biggestAnomaly.deviation > 0 ? 'Exceeds' : 'Falls short'} by ${Math.abs(biggestAnomaly.deviation).toFixed(1)} points`);
            }
            
            if (bestLowAroma) {
                const x = xScale(bestLowAroma.aroma);
                const y = yScale(bestLowAroma.rating);
                
                outlierGroup.append("line")
                    .attr("class", "outlier-line star-line")
                    .attr("x1", x).attr("y1", y)
                    .attr("x2", x + 35).attr("y2", y + 25);
                
                outlierGroup.append("text")
                    .attr("class", "outlier-annotation star-text")
                    .attr("x", x + 40).attr("y", y + 30)
                    .text(`${bestLowAroma.rating} rating despite ${bestLowAroma.aroma}/10 aroma`);
            }
            
            // Store outlier data for interactive controls
            window.aromaOutliers = { anomalies, champions, lowAromaStars };
        }
        
        function updateCharts() {
            width = Math.min(window.innerWidth - 40, 800) - margin.left - margin.right;
            
            createChart("price-chart", "price", "Price per ounce", "price");
            createChart("aroma-chart", "aroma", "Aroma score", "aroma");
            createChart("flavor-chart", "flavor", "Flavor score", "flavor");
        }
        
        // Outlier interaction controls
        function setupOutlierControls() {
            // Flavor chart controls
            const showAll = document.getElementById('show-all');
            const showOverachievers = document.getElementById('show-overachievers');
            const showUnderachievers = document.getElementById('show-underachievers');
            const narrative = document.getElementById('outlier-story');
            
            // Aroma chart controls
            const showAromaAll = document.getElementById('show-aroma-all');
            const showAromaAnomalies = document.getElementById('show-aroma-anomalies');
            const showAromaChampions = document.getElementById('show-aroma-champions');
            const aromaNarrative = document.getElementById('aroma-story');
            
            const flavorNarratives = {
                overachievers: `
                    <strong>The Overachievers:</strong> These coffees punch above their weight, achieving ratings that exceed what their flavor scores predict. 
                    Often, these represent exceptional processing methods, unique terroir, or masterful roasting that elevates the overall experience beyond pure taste. 
                    The highest overachiever exceeds expectations by ${window.flavorOutliers?.overachievers[0]?.deviation.toFixed(1) || 'X'} points‚Äî
                    a testament to the holistic nature of coffee evaluation.
                `,
                underachievers: `
                    <strong>The Disappointments:</strong> Despite high flavor scores, these coffees failed to deliver the complete experience reviewers expected. 
                    This could indicate issues with body, acidity balance, or aftertaste that aren't captured in the flavor metric alone. 
                    The biggest disappointment falls short by ${Math.abs(window.flavorOutliers?.underachievers[0]?.deviation || 0).toFixed(1)} points‚Äî
                    showing that great flavor isn't everything in coffee evaluation.
                `,
                all: ``
            };
            
            const aromaNarratives = {
                anomalies: `
                    <strong>The Aroma Anomalies:</strong> These rare exceptions prove that even the most reliable predictor isn't foolproof. 
                    Some coffees with modest aroma scores achieve surprisingly high ratings, while others with excellent aromas disappoint. 
                    These outliers often represent unique processing methods or reviewer subjectivity that transcends the typical aroma-rating relationship.
                `,
                champions: `
                    <strong>The Aroma Champions:</strong> The coffee elite‚Äîthose achieving 9.5+ aroma scores while earning 95+ ratings. 
                    These represent the pinnacle of coffee craft, where exceptional roasting technique meets premium beans. 
                    Only ${window.aromaOutliers?.champions?.length || 0} coffees in our dataset achieve this perfect combination, 
                    proving that true excellence is indeed rare.
                `,
                all: ``
            };
            
            function updateFlavorOutliers(type) {
                // Update button states
                document.querySelectorAll('#show-all, #show-overachievers, #show-underachievers').forEach(btn => btn.classList.remove('active'));
                
                // Update annotations visibility
                d3.selectAll('.overachiever, .underachiever').classed('show', false);
                d3.selectAll('.overachiever-line, .underachiever-line').style('opacity', 0);
                d3.selectAll('.overachiever-text, .underachiever-text').style('opacity', 0);
                
                // Show narrative
                narrative.innerHTML = flavorNarratives[type];
                narrative.classList.toggle('show', type !== 'all');
                
                if (type === 'overachievers') {
                    showOverachievers.classList.add('active');
                    d3.selectAll('.overachiever').classed('show', true);
                    d3.selectAll('.overachiever-line').style('opacity', 1);
                    d3.selectAll('.overachiever-text').style('opacity', 1);
                } else if (type === 'underachievers') {
                    showUnderachievers.classList.add('active');
                    d3.selectAll('.underachiever').classed('show', true);
                    d3.selectAll('.underachiever-line').style('opacity', 1);
                    d3.selectAll('.underachiever-text').style('opacity', 1);
                } else {
                    showAll.classList.add('active');
                }
            }
            
            function updateAromaOutliers(type) {
                // Update button states
                document.querySelectorAll('#show-aroma-all, #show-aroma-anomalies, #show-aroma-champions').forEach(btn => btn.classList.remove('active'));
                
                // Update annotations visibility
                d3.selectAll('.aroma-anomaly, .aroma-champion, .aroma-star').classed('show', false);
                d3.selectAll('.anomaly-line, .champion-line, .star-line').style('opacity', 0);
                d3.selectAll('.anomaly-text, .champion-text, .star-text').style('opacity', 0);
                
                // Show narrative
                aromaNarrative.innerHTML = aromaNarratives[type];
                aromaNarrative.classList.toggle('show', type !== 'all');
                
                if (type === 'anomalies') {
                    showAromaAnomalies.classList.add('active');
                    d3.selectAll('.aroma-anomaly, .aroma-star').classed('show', true);
                    d3.selectAll('.anomaly-line, .star-line').style('opacity', 1);
                    d3.selectAll('.anomaly-text, .star-text').style('opacity', 1);
                } else if (type === 'champions') {
                    showAromaChampions.classList.add('active');
                    d3.selectAll('.aroma-champion').classed('show', true);
                    d3.selectAll('.champion-line').style('opacity', 1);
                    d3.selectAll('.champion-text').style('opacity', 1);
                } else {
                    showAromaAll.classList.add('active');
                }
            }
            
            // Flavor chart event listeners
            if (showAll) showAll.addEventListener('click', () => updateFlavorOutliers('all'));
            if (showOverachievers) showOverachievers.addEventListener('click', () => updateFlavorOutliers('overachievers'));
            if (showUnderachievers) showUnderachievers.addEventListener('click', () => updateFlavorOutliers('underachievers'));
            
            // Aroma chart event listeners
            if (showAromaAll) showAromaAll.addEventListener('click', () => updateAromaOutliers('all'));
            if (showAromaAnomalies) showAromaAnomalies.addEventListener('click', () => updateAromaOutliers('anomalies'));
            if (showAromaChampions) showAromaChampions.addEventListener('click', () => updateAromaOutliers('champions'));
        }
        
        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const body = document.body;
            
            // Check for saved theme preference or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            body.setAttribute('data-theme', savedTheme);
            
            darkModeToggle.addEventListener('click', () => {
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update chart colors after theme change
                updateCharts();
            });
        }
        
        // Load data and create charts
        d3.json("scatter_data.json").then(function(loadedData) {
            data = loadedData;
            updateCharts();
            
            // Setup dark mode
            initDarkMode();
            
            // Setup outlier controls after charts are created
            setTimeout(() => {
                setupOutlierControls();
            }, 100);
        });
        
        // Responsive updates
        window.addEventListener('resize', updateCharts);
    </script>
</body>
</html>